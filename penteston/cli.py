from penteston.onenote import OneNoteAPI
from jinja2 import Environment, FileSystemLoader
import json
import argparse
import pyperclip


def main(ona):
    parser = argparse.ArgumentParser()
    parser.add_argument('profile', metavar='profile',
                        type=str, help='Path to Configuration JSON')
    parser.add_argument('--notebook', metavar='notebook', type=str,
                        help='OneNote Notebook to work with. Must exist.')
    parser.add_argument('--section', metavar='section', type=str,
                        help='Section within OneNote Notebook to work with.')
    parser.add_argument('--pagename', metavar='page', type=str,
                        help='Path within OneNote Notebook to work with.')
    parser.add_argument('--create', default=False, action='store_true')
    parser.add_argument('--pid', action="store",default=None)
    parser.add_argument('--list', default=False, action='store_true')
    
    parser.add_argument('--pagetemplate', metavar='pageTemplate',
                        default='template.html', help='Path to jinja template to create page.')
    parser.add_argument('--nmaptemplate', metavar='nmapTemplate',
                        default='nmapservice.html', help='Path to jinja template to create nmap table.')
    parser.add_argument('--dump', default=False, action='store_true')
    parser.add_argument('--dumpids', default=False, action='store_true')
    parser.add_argument('--contentclip', default=False, action='store_true')
    parser.add_argument('--nmapxml', action="store",default=None)
    parser.add_argument('--contentid', action="store",default=None)
    parser.add_argument('--content', action="store",default=None)
    parser.add_argument('--pw', action="store",default=None)
    parser.add_argument('--pwclip', default=False, action='store_true')
    parser.add_argument('--pwall', default=False, action='store_true')
    parser.add_argument('--updatetbl', action="store",default=None)
    parser.add_argument('--updatetblid', action="store",default=None)
    parser.add_argument('--matchtbl', action="store",default=None)

    args = parser.parse_args()
    file_loader = FileSystemLoader('templates')
    env = Environment(loader=file_loader)
    config=json.load(open(args.profile,"r"))

    ona._auth(config["client_id"], config["authority"],config["scope"])
    
    if "access_token" in ona.auth:
        #graph_data = requests.get( "https://graph.microsoft.com/v1.0/me", headers={'Authorization': 'Bearer ' + result['access_token']},).json()
        #print("Graph API call result: %s" % json.dumps(graph_data, indent=2))
        me = ona._me()
        if args.list and not args.notebook:
            print(ona._notebooks())
            return
        nid =ona._notebook(args.notebook)
        
        if nid:
            if args.list and not args.section:
                print(ona._sections(nid))
                return
            if args.list and not args.pagename and not args.pid:
                print(ona._pages(nid,args.section))
            if args.create and args.pagename:
                sid = ona._section(nid, args.section)
                if not sid:
                    sid = _createSection(nid, args.section)
                
                template = env.get_template(args.pagetemplate)
                body = template.render(title=args.pagename, args=args, me=me)
                pid = ona._createPage(sid, body)
                print("Created: %s" % pid)
            elif args.pid:
                pid=args.pid
                try:
                    ids=ona._pageIds( pid)
                    if args.dumpids:
                        print(json.dumps(ids, indent=2))
                    if args.nmapxml:
                        template = env.get_template(args.nmaptemplate)
                        atemplate = env.get_template("nmap-a.html")
                        btemplate = env.get_template("nmap-b.html")
                        
                        ona._nmap(pid,_getIdForDataId(ids,"nmap-service-output"),template,atemplate,btemplate,args.nmapxml)
                    if args.contentid:
                        centent=""
                        if args.contentclip:
                            content=pyperclip.paste()
                            print(content)
                        else:
                            content=args.content
                        ona._updatePageSection(pid,content,ona._getIdForDataId(ids,args.contentid),"append")            
                    if args.pw or args.pwclip:
                        fpw=None
                        if args.pw:
                            fpw=open(args.pw)
                        elif args.pwclip:
                            fpw=io.StringIO(pyperclip.paste())
                        for l in fpw:
                            s=l.split(":")
                            if not args.pwall and int(s[2])<499 and int(s[2])>0:
                                continue
                            print(s[0])
                    if args.updatetblid and args.updatetbl and args.matchtbl:
                        t=_getDataIdElement(result,pid,args.updatetblid)
                        ona._updateRow(t,json.loads(args.matchtbl),json.loads(args.updatetbl))
                        c=lxml.html.tostring(t,encoding="unicode")
                        ona._updatePageSection(result,pid,c ,ona._getIdForDataId(ids,args.updatetblid),"replace")
                except:
                    pass
                if args.dump:
                    print(ona._pageContent(pid))
    else:
        print(result.get("error"))
        print(result.get("error_description"))
        # You may need this when reporting a bug
        print(result.get("correlation_id"))


if __name__ == "__main__":
    # execute only if run as a script
    app=OneNoteAPI()
    main(app)